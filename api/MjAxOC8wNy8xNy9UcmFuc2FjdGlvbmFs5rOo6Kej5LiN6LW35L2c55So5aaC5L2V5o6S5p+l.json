{"title":"Transactional注解不起作用如何排查","date":"2018-07-17T11:00:00.000Z","date_formatted":{"ll":"2018年7月17日","L":"2018/07/17","MM-DD":"07-17"},"link":"2018/07/17/Transactional注解不起作用如何排查","tags":["事务"],"categories":["工作"],"updated":"2024-10-10T08:03:05.460Z","content":"<p>当@Transactional不起作用如何排查问题<span id=\"more\"></span></p>\n<p>可以按照以下几个步骤逐一确认：</p>\n<ol>\n<li>\n<p>首先要看数据库本身对应的库、表所设置的引擎是什么。MyIsam不支持事务，如果需要，则必须改为InnnoDB。</p>\n</li>\n<li>\n<p>@Transactional所注解的方法是否为public</p>\n</li>\n<li>\n<p>@Transactional所注解的方法所在的类，是否已经被注解@Service或@Component等。</p>\n</li>\n<li>\n<p>需要调用该方法，且需要支持事务特性的调用方是在在 @Transactional所在的类的外面。注意：类内部的其他方法调用这个注解了@Transactional的方法，事务是不会起作用的。</p>\n</li>\n<li>\n<p>注解为事务范围的方法中，事务的回滚仅仅对于unchecked的异常有效。对于checked异常无效。也就是说事务回滚仅仅发生在出现RuntimeException或Error的时候。</p>\n</li>\n</ol>\n<p>如果希望一般的异常也能触发事务回滚，需要在注解了@Transactional的方法上，将@Transactional回滚参数设为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@Transactional(rollbackFor=Exception.class)</span><br></pre></td></tr></table></figure>\n<ol start=\"6\">\n<li>非springboot项目，需要检查spring配置文件xml中：</li>\n</ol>\n<blockquote>\n<p>扫描包范围是否配置好，否则不会在启动时spring容器中创建和加载对应的bean对象。</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;context:component-scan base-package=&quot;com.happybks&quot; &gt;&lt;/context:component-scan&gt;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>事务是否已经配置成开启</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;tx:annotation-driven transaction-manager=&quot;transactionManager&quot; proxy-target-class=&quot;true&quot;/&gt;</span><br></pre></td></tr></table></figure>\n<ol start=\"7\">\n<li>springboot项目有两个可选配置，默认已经支持事务了，可以写也可以不写。</li>\n</ol>\n<blockquote>\n<p>springboot启动类，即程序入口类，需要注解@EnableTransactionManagement</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@EnableTransactionManagement</span><br><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">public class PetsApplication &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpublic static void main(String[] args) &#123;</span><br><span class=\"line\">\t\tSpringApplication.run(PetsApplication.class, args);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>springboot配置文件application.yml中，可以配置上失败回滚：</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:</span><br><span class=\"line\">  profiles:</span><br><span class=\"line\">    active: prod</span><br><span class=\"line\">  datasource:</span><br><span class=\"line\">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class=\"line\">    url: jdbc:mysql://127.0.0.1:3306/spbdb</span><br><span class=\"line\">    username: root</span><br><span class=\"line\">    password:</span><br><span class=\"line\">  jpa:</span><br><span class=\"line\">    hibernate:</span><br><span class=\"line\">      ddl-auto:</span><br><span class=\"line\">    show-sql: true</span><br><span class=\"line\">  transaction:</span><br><span class=\"line\">    rollback-on-commit-failure: true</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\">参考<a title=\"#参考\" href=\"#参考\"></a></h2>\n<p><a href=\"https://my.oschina.net/happyBKs/blog/1624482\" target=\"_blank\">当@Transactional不起作用如何排查问题</a></p>\n","prev":{"title":"AUFS基本原理","link":"2018/07/29/AUFS基本原理"},"next":{"title":"Java字节码相关知识","link":"2018/06/15/Java字节码相关知识"},"plink":"https://zinki.github.io/2018/07/17/Transactional注解不起作用如何排查/","toc":[{"id":"参考","title":"参考","index":"1"}]}