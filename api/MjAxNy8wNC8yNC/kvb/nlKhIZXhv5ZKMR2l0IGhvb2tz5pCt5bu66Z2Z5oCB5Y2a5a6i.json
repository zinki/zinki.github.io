{"title":"使用Hexo和Git hooks搭建静态博客","date":"2017-04-24T02:14:00.000Z","date_formatted":{"ll":"2017年4月24日","L":"2017/04/24","MM-DD":"04-24"},"link":"2017/04/24/使用Hexo和Git hooks搭建静态博客","tags":["Hexo"],"categories":["学习"],"updated":"2024-10-10T08:03:05.463Z","content":"<p>之前用Git Pages搭建博客，有个缺陷，要么付费，要么放在公共仓库，刚好git前几天宣布私有仓库免费，周末研究了下，把博客站点放到VPS上面。其间遇到很多坑，大多是和权限相关，遇到问题可以见招拆招。<span id=\"more\"></span></p>\n<h2 id=\"服务端\">服务端<a title=\"#服务端\" href=\"#服务端\"></a></h2>\n<h3 id=\"安装所需环境，包括-git，nginx\">安装所需环境，包括 git，Nginx<a title=\"#安装所需环境，包括-git，nginx\" href=\"#安装所需环境，包括-git，nginx\"></a></h3>\n<h3 id=\"创建一个-&lt;code&gt;git&lt;/code&gt;-用户，用来运行-&lt;code&gt;git&lt;/code&gt;-服务：\">创建一个 <code>git</code> 用户，用来运行 <code>git</code> 服务：<a title=\"#创建一个-&lt;code&gt;git&lt;/code&gt;-用户，用来运行-&lt;code&gt;git&lt;/code&gt;-服务：\" href=\"#创建一个-&lt;code&gt;git&lt;/code&gt;-用户，用来运行-&lt;code&gt;git&lt;/code&gt;-服务：\"></a></h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo adduser git</span><br><span class=\"line\">$ sudo passwd password</span><br></pre></td></tr></table></figure>\n<h3 id=\"授权sudo权限\">授权sudo权限<a title=\"#授权sudo权限\" href=\"#授权sudo权限\"></a></h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"comment\">#编辑 sudo 分组</span></span><br><span class=\"line\">$ sudo visudo</span><br><span class=\"line\">$ ...</span><br><span class=\"line\">  root    ALL=(ALL)       ALL</span><br><span class=\"line\">  git   ALL=(ALL)       NOPASSWD: ALL    <span class=\"comment\">#免密配置</span></span><br><span class=\"line\">  ...</span><br></pre></td></tr></table></figure>\n<h3 id=\"创建公钥\">创建公钥<a title=\"#创建公钥\" href=\"#创建公钥\"></a></h3>\n<p>将<code>id_rsa.pub</code>文件内容添加到服务器/home/git/.ssh/authorized_keys文件中<br>\n如果你之前没有生成过公钥，则可能就没有 <code>id_rsa.pub</code> 文件，具体的生成方法，可以参考这里。<br>\n测试方法: <code>ssh git@IP</code></p>\n<h3 id=\"初始化-&lt;code&gt;git&lt;/code&gt;-仓库\">初始化 <code>Git</code> 仓库<a title=\"#初始化-&lt;code&gt;git&lt;/code&gt;-仓库\" href=\"#初始化-&lt;code&gt;git&lt;/code&gt;-仓库\"></a></h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> /home/git</span><br><span class=\"line\">$ sudo git init --bare hexo.git</span><br></pre></td></tr></table></figure>\n<ol>\n<li>使用 git init --bare <repo> 可以创建一个裸仓库，并且这个仓库是可以被正常 clone 和 push 更新的， 裸仓库不包含工作区，所以并不会存在在裸仓库上直接提交变更的情况，裸仓库一般情况下是作为远端的中心仓库而存在的</li>\n<li>配置 <code>git hooks</code>，关于 <code>hooks</code> 的详情内容可以<a href=\"https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks\" target=\"_blank\">参考这里</a></li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> /var/repo/blog.git/hooks</span><br><span class=\"line\">$ vim post-receive</span><br></pre></td></tr></table></figure>\n<ol start=\"3\">\n<li>在 <code>post-receive</code> 文件中写入如下内容：</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">sudo rm -rf /var/www/blog</span><br><span class=\"line\">git <span class=\"built_in\">clone</span> /home/git/hexo.git /var/www/blog</span><br></pre></td></tr></table></figure>\n<ol start=\"4\">\n<li>不要忘记设置这个文件的可执行权限：</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod +x post-receive</span><br><span class=\"line\">$ sudo git init --bare hexo.git</span><br></pre></td></tr></table></figure>\n<ol start=\"5\">\n<li>创建站点部署目录</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> /var/ &amp;&amp; mkdir -p www/blog</span><br></pre></td></tr></table></figure>\n<ol start=\"6\">\n<li>添加git用户权限</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo chown -R git:git hexo.git</span><br><span class=\"line\">$ sudo chown -R git:git /var/www</span><br></pre></td></tr></table></figure>\n<h3 id=\"禁用-&lt;code&gt;git&lt;/code&gt;-用户的-&lt;code&gt;shell&lt;/code&gt;-登录权限\">禁用 <code>git</code> 用户的 <code>shell</code> 登录权限<a title=\"#禁用-&lt;code&gt;git&lt;/code&gt;-用户的-&lt;code&gt;shell&lt;/code&gt;-登录权限\" href=\"#禁用-&lt;code&gt;git&lt;/code&gt;-用户的-&lt;code&gt;shell&lt;/code&gt;-登录权限\"></a></h3>\n<p>编辑 <code>/etc/passwd</code> 来实现，在 <code>/etc/passwd</code> 中找到类似下面的一行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git:x:1001:1001:,,,:/home/git:/bin/bash</span><br></pre></td></tr></table></figure>\n<p>将其改为:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git:x:1001:1001:,,,:/home/git:/usr/bin/git-shell</span><br></pre></td></tr></table></figure>\n<p>这样 <code>git</code> 用户可以通过 <code>ssh</code> 正常使用 <code>git</code>，但是无法登录 <code>shell</code>。</p>\n<h2 id=\"客户端\">客户端<a title=\"#客户端\" href=\"#客户端\"></a></h2>\n<h3 id=\"安装-&lt;code&gt;nodejs&lt;/code&gt;，&lt;code&gt;hexo&lt;/code&gt;\">安装 <code>nodeJs</code>，<code>hexo</code><a title=\"#安装-&lt;code&gt;nodejs&lt;/code&gt;，&lt;code&gt;hexo&lt;/code&gt;\" href=\"#安装-&lt;code&gt;nodejs&lt;/code&gt;，&lt;code&gt;hexo&lt;/code&gt;\"></a></h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew update</span><br><span class=\"line\">brew install node</span><br><span class=\"line\"><span class=\"comment\"># 安装hexo</span></span><br><span class=\"line\">npm install hexo-cli -g</span><br></pre></td></tr></table></figure>\n<h3 id=\"初始化-&lt;code&gt;hexo&lt;/code&gt;-&amp;&amp;-修改仓库地址\">初始化 <code>Hexo</code> &amp;&amp; 修改仓库地址<a title=\"#初始化-&lt;code&gt;hexo&lt;/code&gt;-&amp;&amp;-修改仓库地址\" href=\"#初始化-&lt;code&gt;hexo&lt;/code&gt;-&amp;&amp;-修改仓库地址\"></a></h3>\n<ol>\n<li>在本地目录执行初始化</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo init hexo</span><br><span class=\"line\"><span class=\"built_in\">cd</span> hexo</span><br><span class=\"line\">npm install hexo-deployer-git --save</span><br><span class=\"line\">vi _config.yml</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>跳到最后一行，修改仓库地址，允许配置多个</li>\n</ol>\n<figure class=\"highlight basic\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">deploy:</span><br><span class=\"line\">- type: git</span><br><span class=\"line\">  repo: git@IP:/home/git/hexo.git</span><br><span class=\"line\">  branch: master</span><br><span class=\"line\">- type: git</span><br><span class=\"line\">  repo: git@github.<span class=\"keyword\">com</span>:user/blog.git</span><br><span class=\"line\">  branch: master</span><br></pre></td></tr></table></figure>\n<h3 id=\"依次执行即可实现动态部署\">依次执行即可实现动态部署<a title=\"#依次执行即可实现动态部署\" href=\"#依次执行即可实现动态部署\"></a></h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo g</span><br><span class=\"line\">hexo s</span><br><span class=\"line\">hexo d</span><br></pre></td></tr></table></figure>\n<h2 id=\"后续拓展\">后续拓展<a title=\"#后续拓展\" href=\"#后续拓展\"></a></h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 插件hexo-auto-excerpt </span></span><br><span class=\"line\"><span class=\"comment\"># 不需要时uninstall方起作用</span></span><br><span class=\"line\"><span class=\"comment\"># hexo推荐使用&lt;!--more--&gt;</span></span><br><span class=\"line\">npm install hexo-excerpt --save</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 看板娘</span></span><br><span class=\"line\">npm install --save hexo-helper-live2d</span><br><span class=\"line\"></span><br><span class=\"line\">npm install live2d-widget-model-haru</span><br><span class=\"line\">npm install live2d-widget-model-shizuku</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\">参考<a title=\"#参考\" href=\"#参考\"></a></h2>\n<p><a href=\"http://www.swiftyper.com/2016/04/17/deploy-hexo-with-git-hook/\" target=\"_blank\">使用 <code>Git Hook</code> 自动部署 <code>Hexo</code> 到个人 <code>VPS</code></a><br>\n<a href=\"https://github.com/chekun/hexo-excerpt\" target=\"_blank\">博客摘要hexo-excerpt</a></p>\n","prev":{"title":"免费升级Https","link":"2017/04/29/免费升级Https"},"plink":"https://zinki.github.io/2017/04/24/使用Hexo和Git hooks搭建静态博客/","toc":[{"id":"服务端","title":"服务端","index":"1","children":[{"id":"安装所需环境，包括-git，nginx","title":"安装所需环境，包括 git，Nginx","index":"1.1"},{"id":"创建一个-<code>git</code>-用户，用来运行-<code>git</code>-服务：","title":"创建一个 git 用户，用来运行 git 服务：","index":"1.2"},{"id":"授权sudo权限","title":"授权sudo权限","index":"1.3"},{"id":"创建公钥","title":"创建公钥","index":"1.4"},{"id":"初始化-<code>git</code>-仓库","title":"初始化 Git 仓库","index":"1.5"},{"id":"禁用-<code>git</code>-用户的-<code>shell</code>-登录权限","title":"禁用 git 用户的 shell 登录权限","index":"1.6"}]},{"id":"客户端","title":"客户端","index":"2","children":[{"id":"安装-<code>nodejs</code>，<code>hexo</code>","title":"安装 nodeJs，hexo","index":"2.1"},{"id":"初始化-<code>hexo</code>-&&-修改仓库地址","title":"初始化 Hexo &amp;&amp; 修改仓库地址","index":"2.2"},{"id":"依次执行即可实现动态部署","title":"依次执行即可实现动态部署","index":"2.3"}]},{"id":"后续拓展","title":"后续拓展","index":"3"},{"id":"参考","title":"参考","index":"4"}]}