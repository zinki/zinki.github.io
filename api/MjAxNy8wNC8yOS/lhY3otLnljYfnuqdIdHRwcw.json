{"title":"免费升级Https","date":"2017-04-29T09:57:00.000Z","date_formatted":{"ll":"2017年4月29日","L":"2017/04/29","MM-DD":"04-29"},"link":"2017/04/29/免费升级Https","tags":["Https"],"categories":["学习"],"updated":"2024-10-10T08:03:05.464Z","content":"<p>Https正在流行,刚好了解到<a href=\"https://letsencrypt.org/\" target=\"_blank\">Let’s Encryp</a>免费提供证书,借此把博客升级一下 <span id=\"more\"></span></p>\n<h2 id=\"到官网申请证书\">到官网申请证书<a title=\"#到官网申请证书\" href=\"#到官网申请证书\"></a></h2>\n<p>具体步骤按提示一步一步来,最终得到这样的提示说明证书已经生成</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">** DRY RUN: simulating <span class=\"string\">&#x27;certbot renew&#x27;</span> close to cert expiry</span><br><span class=\"line\">**          (The <span class=\"built_in\">test</span> certificates below have not been saved.)</span><br><span class=\"line\"></span><br><span class=\"line\">Congratulations, all renewals succeeded. The following certs have been renewed:</span><br><span class=\"line\">  /etc/letsencrypt/live/zeroz.top/fullchain.pem (success)</span><br><span class=\"line\">** DRY RUN: simulating <span class=\"string\">&#x27;certbot renew&#x27;</span> close to cert expiry</span><br><span class=\"line\">**          (The <span class=\"built_in\">test</span> certificates above have not been saved.)</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx配置升级\">nginx配置升级<a title=\"#nginx配置升级\" href=\"#nginx配置升级\"></a></h2>\n<p>编辑配置文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /etc/nginx/conf.d/https.conf</span><br></pre></td></tr></table></figure>\n<p>重定向到htpps</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen 80;</span><br><span class=\"line\">server_name zeroz.top;</span><br><span class=\"line\">rewrite ^(.*) https://$server_name<span class=\"variable\">$1</span> permanent;</span><br></pre></td></tr></table></figure>\n<p>编辑配置文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight basic\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen       <span class=\"number\">443</span> ssl http2 default_server;</span><br><span class=\"line\">        listen       [::]:<span class=\"number\">443</span> ssl http2 default_server;</span><br><span class=\"line\">        server_name  zeroz.top;</span><br><span class=\"line\">        root         /<span class=\"keyword\">usr</span>/share/nginx/html;</span><br><span class=\"line\"></span><br><span class=\"line\">        ssl <span class=\"keyword\">on</span>;</span><br><span class=\"line\">        ssl_certificate <span class=\"string\">&quot;/etc/letsencrypt/live/zeroz.top/fullchain.pem&quot;</span>;</span><br><span class=\"line\">        ssl_certificate_key <span class=\"string\">&quot;/etc/letsencrypt/live/zeroz.top/privkey.pem&quot;</span>;</span><br><span class=\"line\">        ssl_session_cache shared:SSL:<span class=\"number\">1</span>m;</span><br><span class=\"line\">        ssl_session_timeout  <span class=\"number\">10</span>m;</span><br><span class=\"line\">        ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class=\"line\">        ssl_prefer_server_ciphers <span class=\"keyword\">on</span>;</span><br><span class=\"line\">#</span><br><span class=\"line\">#        # <span class=\"keyword\">Load</span> configuration <span class=\"keyword\">files</span> <span class=\"keyword\">for</span> the default server block.</span><br><span class=\"line\">#        include /etc/nginx/default.d/*.conf;</span><br><span class=\"line\">#</span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location /blog &#123;</span><br><span class=\"line\">            root /var/www/;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location ~ .*\\.(eot|ttf|woff|woff2)$</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            root /var/www/;</span><br><span class=\"line\">            add_header Access-Control-Allow-Origin *;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        error_page <span class=\"number\">404</span> /<span class=\"number\">404</span>.html;</span><br><span class=\"line\">            location = /<span class=\"number\">40</span>x.html &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        error_page <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span> /<span class=\"number\">50</span>x.html;</span><br><span class=\"line\">            location = /<span class=\"number\">50</span>x.html &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>重启nginx</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ nginx -s reload</span><br></pre></td></tr></table></figure>\n<h2 id=\"第三步-证书续订\">第三步 证书续订<a title=\"#第三步-证书续订\" href=\"#第三步-证书续订\"></a></h2>\n<h3 id=\"利用cron定时续订证书\">利用cron定时续订证书<a title=\"#利用cron定时续订证书\" href=\"#利用cron定时续订证书\"></a></h3>\n<p>因为证书每90天过期,certbot很贴心的提供了证书延期命令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo certbot renew --dry-run</span><br></pre></td></tr></table></figure>\n<p>配置cron命令让服务器定时执行即可实现自动化</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -e</span><br><span class=\"line\"><span class=\"comment\">#添加cron</span></span><br><span class=\"line\">0 0,3 * * * python -c<span class=\"string\">&#x27;导入随机; 进口时间; time.sleep（random.random（）* 3600）&#x27;</span>&amp;&amp; certbot renew</span><br><span class=\"line\"><span class=\"comment\">#编辑完成</span></span><br><span class=\"line\">$ /bin/systemctl start crond.service</span><br></pre></td></tr></table></figure>\n<h3 id=\"也可用cron执行shell\">也可用cron执行shell<a title=\"#也可用cron执行shell\" href=\"#也可用cron执行shell\"></a></h3>\n<p>之前cron不会执行的原因是环境变量，需要调整crontab规则</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SHELL=/bin/sh</span><br><span class=\"line\">PATH=/usr/<span class=\"built_in\">local</span>/sbin:/usr/<span class=\"built_in\">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class=\"line\"></span><br><span class=\"line\">* * */1 * * ./etc/profile;/bin/sh /usr/sbin/certbot.sh</span><br></pre></td></tr></table></figure>\n<p>脚本附下</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#! /bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># Certbot Automating renewal</span></span><br><span class=\"line\">nginx=<span class=\"string\">&quot;/usr/sbin/nginx&quot;</span></span><br><span class=\"line\">prog=$(basename <span class=\"variable\">$nginx</span>)</span><br><span class=\"line\">NGINX_CONF_FILE=<span class=\"string\">&quot;/etc/nginx/nginx.conf&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> 开始停止nginx</span><br><span class=\"line\">nginx -s stop</span><br><span class=\"line\"><span class=\"built_in\">echo</span> 开始续订证书</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># sudo certbot renew --dry-run</span></span><br><span class=\"line\">sudo certbot renew --dry-run</span><br><span class=\"line\"><span class=\"built_in\">echo</span> 启动nginx</span><br><span class=\"line\">nginx</span><br><span class=\"line\"><span class=\"built_in\">echo</span> 证书续订结束</span><br></pre></td></tr></table></figure>\n<h2 id=\"问题\">问题<a title=\"#问题\" href=\"#问题\"></a></h2>\n<p>Let’s Encryp致力于推广Https,操作步骤已经很简单了,有一点问题就是证书的生成和续订需要http请求,而nginx默认的监听端口也是80,所以会报端口占用.需要先关闭nginx,续订完成再启动</p>\n<p>上述脚本sudo certbot renew --dry-run当中–dry-run不会保存生成证书<br>\n** DRY RUN: simulating ‘certbot renew’ close to cert expiry<br>\n**          (The test certificates above have not been saved.)</p>\n<p>Another instance of Certbot is already running (Letsencrypt)<br>\nIf it is not running, check whether there are .certbot.lock files in your system.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find / -<span class=\"built_in\">type</span> f -name <span class=\"string\">&quot;.certbot.lock&quot;</span></span><br></pre></td></tr></table></figure>\n<p>If there are, you can remove them:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find / -<span class=\"built_in\">type</span> f -name <span class=\"string\">&quot;.certbot.lock&quot;</span> -<span class=\"built_in\">exec</span> rm &#123;&#125; \\;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\">参考<a title=\"#参考\" href=\"#参考\"></a></h2>\n<p><a href=\"https://certbot.eff.org/lets-encrypt/centosrhel7-nginx\" target=\"_blank\">Certbot：Automatically enable HTTPS on your website with EFF’s Certbot, deploying Let’s Encrypt certificates</a></p>\n","prev":{"title":"Crontab的一些事","link":"2017/05/07/Crontab的一些事"},"next":{"title":"使用Hexo和Git hooks搭建静态博客","link":"2017/04/24/使用Hexo和Git hooks搭建静态博客"},"plink":"https://zinki.github.io/2017/04/29/免费升级Https/","toc":[{"id":"到官网申请证书","title":"到官网申请证书","index":"1"},{"id":"nginx配置升级","title":"nginx配置升级","index":"2"},{"id":"第三步-证书续订","title":"第三步 证书续订","index":"3","children":[{"id":"利用cron定时续订证书","title":"利用cron定时续订证书","index":"3.1"},{"id":"也可用cron执行shell","title":"也可用cron执行shell","index":"3.2"}]},{"id":"问题","title":"问题","index":"4"},{"id":"参考","title":"参考","index":"5"}]}